{% extends "base.html" %}

{% block content %}
{% load static %}
<div class="header-fixed">
  <img src="{% static 'guide/images/hanwha.png' %}" alt="í•œí™”ì†í•´ë³´í—˜ CI" onclick="goHome()">
</div>

{% if user_name %}
<div class="user-info">
  <span>ğŸ‘¤ {{ user_name }}</span>
  <form action="{% url 'logout' %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
  </form>
</div>
{% endif %}

<div id="searchScreen" class="card container-narrow">
  <h2 style="margin-bottom:.5rem;">ê°€ì´ë“œ ê²€ìƒ‰</h2>

  <!-- âœ… ì²˜ìŒì—ëŠ” ë²„íŠ¼ë§Œ ë³´ì´ê²Œ -->
  {% if not guide_type %}
    <div style="margin-bottom: 1rem;">
      <form method="post" action="{% url 'search' %}">
        {% csrf_token %}
        <input type="hidden" name="guide" value="chronic">
        <button type="submit">ê±´ê°•/ì¼ë°˜/ê°„í¸ ì¸ìˆ˜ê°€ì´ë“œ</button>
      </form>
      <form method="post" action="{% url 'search' %}">
        {% csrf_token %}
        <input type="hidden" name="guide" value="fetal">
        <button type="submit">íƒœì•„ ì¸ìˆ˜ê°€ì´ë“œ</button>
      </form>
      <button type="button" onclick="showLimitScreen()">ìƒí’ˆë³„ ì¸ìˆ˜í•œë„</button>
    </div>
  {% else %}
    <!-- âœ… ê°€ì´ë“œ ì„ íƒ í›„ ê²€ìƒ‰ì°½ -->
    <div style="margin: 1rem 0; font-weight: bold; font-size: 16px;">
      {% if guide_type == "chronic" %}
        ğŸ“˜ í˜„ì¬ ì„ íƒëœ ê°€ì´ë“œ: <span style="color: #007bff;">ê±´ê°•/ì¼ë°˜/ê°„í¸ ì¸ìˆ˜ê°€ì´ë“œ</span>
      {% elif guide_type == "fetal" %}
        ğŸ‘¶ í˜„ì¬ ì„ íƒëœ ê°€ì´ë“œ: <span style="color: #ff5722;">íƒœì•„ ì¸ìˆ˜ê°€ì´ë“œ</span>
      {% endif %}
    </div>
    <form method="post" action="{% url 'search' %}">
      {% csrf_token %}
      <input type="hidden" id="guideType" name="guide" value="{{ guide_type }}">
      <input type="text" name="query" placeholder="ì§ˆë³‘ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required value="{{ query }}">
      <button type="submit">ê²€ìƒ‰</button>
    </form>

    <!-- âœ… ê²°ê³¼ ì˜ì—­ -->
    {% if guide_type == "chronic" and results %}
      <div class="results">
        {% for d in results %}
        <div class="result-card">
          <div class="result-title">{{ d.name }}</div>
          <table class="info-table">
            <tr>
              <th style="width:55px; white-space:pre-line;">ê±´ê°•<br>ê³ ì§€</th>
              <td style="white-space: pre-line;">{{ d.health|default:"-" }}</td>
            </tr>
            <tr>
              <th style="width:55px; white-space:pre-line;">ì¼ë°˜<br>ê³ ì§€</th>
              <td style="white-space: pre-line;">{{ d.general|default:"-" }}</td>
            </tr>
            <tr>
              <th style="width:55px; white-space:pre-line;">ê°„í¸<br>ê³ ì§€</th>
              <td style="white-space: pre-line;">{{ d.simple|default:"-" }}</td>
            </tr>
          </table>
        </div>
        {% endfor %}
      </div>

    {% elif guide_type == "fetal" and results %}
      <div class="results">
        {% for d in results %}
        <div class="result-card">
          <div class="result-title">{{ d.disease }}</div>
          <table class="info-table">
            <tr>
              <th>í˜„ì¦</th>
              <td style="white-space: pre-line;">{{ d.current|default:"-" }}</td>
            </tr>
            <tr>
              <th>ê³¼ê±°ë ¥/ì¹˜ë£Œë ¥</th>
              <td style="white-space: pre-line;">{{ d.history|default:"-" }}</td>
            </tr>
          </table>
          <div class="restrictions">í•„ìš”ì„œë¥˜:<br>{{ d.documents|default:"ì—†ìŒ" }}</div>
        </div>
        {% endfor %}
      </div>
    {% elif query %}
      <div class="hint">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    {% endif %}
  {% endif %}
  <!-- ë³´í—˜ì‚¬ ëª©ë¡ -->
  <div class="insurance-section">
    {% if hanwha %}
      <div class="insurance-card hanwha">
        <h3>{{ hanwha.company }}</h3>
        <div class="contact-item">ğŸ“ ì½œì„¼í„°: <a href="tel:{{ hanwha.callCenter|cut:'-' }}">{{ hanwha.callCenter }}</a></div>
        <div class="contact-item">ğŸ“„ ë³´í—˜ê¸ˆì²­êµ¬: {{ hanwha.fax }}</div>
        <div class="contact-item">ğŸ“š <a href="{{ hanwha.termsUrl }}" target="_blank" rel="noopener">ê³µì‹œì‹¤ ë°”ë¡œê°€ê¸°</a></div>
      </div>
    {% endif %}
  
    {% regroup insurances by type as grouped %}
    {% for group in grouped %}
      <div class="insurance-category">
        <h3>{{ group.grouper }}</h3>
        <div class="insurance-grid">
          {% for ins in group.list %}
            <div class="insurance-card">
              <h4>{{ ins.company }}</h4>
              <div class="contact-item">ğŸ“ ì½œì„¼í„°: <a href="tel:{{ ins.callCenter|cut:'-' }}">{{ ins.callCenter }}</a></div>
              <div class="contact-item">ğŸ“„ ë³´í—˜ê¸ˆì²­êµ¬:<br>{{ ins.fax }}</div>
              <div class="contact-item"><span>ğŸ“š<a href="{{ ins.termsUrl }}" target="_blank" rel="noopener">ê³µì‹œì‹¤ ë°”ë¡œê°€ê¸°</a></span></div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
<!-- âœ… ì¸ìˆ˜í•œë„ í™”ë©´ -->
<section id="limitScreen" class="screen" style="display:none;">
  <div class="app-title">ìƒí’ˆë³„/í”Œëœë³„ ì¸ìˆ˜í•œë„</div>
  <div class="card container-narrow">
    <h2 style="margin-bottom:1rem;">ìƒí’ˆ ë° í”Œëœ ì„ íƒ</h2>

    <div class="row">
      <select id="productSelect">
        <option value="">ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>

    <div class="row">
      <select id="planSelect" disabled>
        <option value="">í”Œëœì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>

    <div class="row" id="ageSelectRow" style="display:none;">
      <select id="ageSelect" disabled>
        <option value="">ì—°ë ¹êµ¬ê°„ì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>

    <button type="button" onclick="hideLimitScreen()" class="secondary" style="margin-top:8px;">ë’¤ë¡œê°€ê¸°</button>

    <!-- âœ… ê²°ê³¼ í‘œ -->
    <table class="info-table" style="margin-top:1rem;">
      <thead>
        <tr>
          <th>ë‹´ë³´ëª…</th>
          <th>ì¸ìˆ˜í•œë„</th>
        </tr>
      </thead>
      <tbody id="limitTableBody">
        <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
      </tbody>
    </table>
  </div>
</section>
  


{% endblock %}

{% block extra_js %}
<script>
  window.showLimitScreen = function () {
    document.getElementById("searchScreen").style.display = "none";
    document.getElementById("limitScreen").style.display = "block";
  };

  window.hideLimitScreen = function () {
    document.getElementById("limitScreen").style.display = "none";
    document.getElementById("searchScreen").style.display = "block";
  };

  window.initLimitScreen = function () {
    const productSelect = document.getElementById("productSelect");
    const planSelect = document.getElementById("planSelect");
    const ageSelect = document.getElementById("ageSelect");
    const ageSelectRow = document.getElementById("ageSelectRow");
    const tableBody = document.getElementById("limitTableBody");

    // ìƒí’ˆ ëª©ë¡
    fetch("/limits/products/")
      .then(res => res.json())
      .then(products => {
        products.forEach(p => {
          let opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          productSelect.appendChild(opt);
        });
      });

    // ìƒí’ˆ ì„ íƒ â†’ í”Œëœ
    productSelect.addEventListener("change", () => {
      planSelect.innerHTML = '<option value="">í”Œëœì„ ì„ íƒí•˜ì„¸ìš”</option>';
      planSelect.disabled = true;
      ageSelectRow.style.display = "none";
      tableBody.innerHTML = "";

      if (productSelect.value) {
        fetch(`/limits/plans/?product=${productSelect.value}`)
          .then(res => res.json())
          .then(plans => {
            plans.forEach(p => {
              let opt = document.createElement("option");
              opt.value = p;
              opt.textContent = p;
              planSelect.appendChild(opt);
            });
            planSelect.disabled = false;
          });
      }
    });

    // í”Œëœ ì„ íƒ â†’ ì—°ë ¹
    planSelect.addEventListener("change", () => {
      ageSelect.innerHTML = '<option value="">ì—°ë ¹êµ¬ê°„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      ageSelect.disabled = true;
      tableBody.innerHTML = "";

      if (planSelect.value) {
        fetch(`/limits/ages/?product=${productSelect.value}&plan=${planSelect.value}`)
          .then(res => res.json())
          .then(ages => {
            ages.forEach(a => {
              let opt = document.createElement("option");
              opt.value = Math.floor((a.minAge + a.maxAge) / 2);
              opt.textContent = `${a.minAge}ì„¸ ~ ${a.maxAge}ì„¸`;
              ageSelect.appendChild(opt);
            });
            ageSelect.disabled = false;
            ageSelectRow.style.display = "block";
          });
      }
    });

    // ì—°ë ¹ ì„ íƒ â†’ ê²°ê³¼
    ageSelect.addEventListener("change", () => {
      tableBody.innerHTML = "";
      if (ageSelect.value) {
        fetch(`/limits/results/?product=${productSelect.value}&plan=${planSelect.value}&age=${ageSelect.value}`)
          .then(res => res.json())
          .then(data => {
            if (data.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="2" class="hint">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
              data.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td class="coverage-name">${r.coverage}</td>
                  <td class="amount">${r.amount}</td>
                `;
                tableBody.appendChild(tr);
              });
            }
          });
      }
    });
  };

  document.addEventListener("DOMContentLoaded", window.initLimitScreen);
</script>
{% endblock %}

{% block extra_css %}
<style>
.header-fixed{
  top:0; left:0; right:0;
  background:var(--bg);
  border-bottom:2px solid #ccc;
  text-align:center;
  padding:10px 0;
  box-shadow:0 2px 4px rgba(0,0,0,.08);
}
.header-fixed img{
  height: 50px; /* í¬ê¸° ì¡°ì • */
  width: auto;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.header-fixed img:hover {
  transform: scale(1.05);
}
.user-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f8f9fa;
  padding: 10px 14px;
  border-radius: 8px;
/*   margin: 80px auto 20px;  /* ? í—¤ë”(ì•½ 60px) + ì—¬ìœ  â†’ ì•„ë˜ë¡œ ë‚´ë¦¼ */
  font-size: 15px; */
  font-weight: 600;
  color: #333;
  max-width: 600px;        /* ? ê°€ìš´ë° ì •ë ¬ & ê°€ë¡œí­ ì œí•œ */
}
.logout-btn {
  background: #dc3545;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 14px;
  font-size: 13px;
  cursor: pointer;
  white-space: nowrap;  /* ? ì¤„ë°”ê¿ˆ ë°©ì§€ */
  display: inline-block; /* ? ê°•ì œë¡œ ì¸ë¼ì¸ ë¸”ë¡ ì²˜ë¦¬ */
}
.logout-btn:hover {
  background: #b02a37;
}
/* ê²°ê³¼ ì¹´ë“œ */
.result-card {
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 14px;
}
.result-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}
.result-si {
  color: #0000ff;
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}
.result-sig {
  color: #ff00ff;
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}
/* .info-table {
  width: 100%;
  border-collapse: collapse;
  margin: 8px 0;
} */
.info-table th {
  text-align: center;
  font-size: 13px;
  line-height: 1.2;
  white-space: pre-line;  /* âœ… ì¤„ë°”ê¿ˆ ì ìš© */
  background: #f9f9f9;
}
.info-table td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
  font-size: 14px;
  text-align: left;
  white-space: pre-line; /* âœ… \n ì¤„ë°”ê¿ˆ ë°˜ì˜ */
}
.info-table th {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
  font-size: 14px;
}
.restrictions {
  margin-top: 8px;
  padding: 8px;
  background: #fafafa;
  border: 1px dashed #ddd;
  border-radius: 6px;
  font-size: 14px;
  white-space: pre-line;
}

/* ? ë³´í—˜ì‚¬ ì¹´ë“œ 2ì—´ ê·¸ë¦¬ë“œ (ëª¨ë°”ì¼ í¬í•¨ í•­ìƒ ìœ ì§€) */
.insurance-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr)); /* í•œ ì¤„ì— í•­ìƒ 2ê°œ */
  gap: 12px; /* ì¹´ë“œ ì‚¬ì´ ì—¬ë°± */
}

/* (ì„ íƒ) í•œí™”ì†ë³´ ê°•ì¡°ì¹´ë“œê°€ ê·¸ë¦¬ë“œì— í¬í•¨ë  ê²½ìš° ë‘ ì¹¸ ì°¨ì§€ */
.insurance-card.span-2 {
  grid-column: 1 / -1;
}
  
/* (ì„ íƒ) ì¹´í…Œê³ ë¦¬ ì œëª©ê³¼ ê·¸ë¦¬ë“œ ì‚¬ì´ ì—¬ë°± ë‹¤ë“¬ê¸° */
.insurance-category > .insurance-grid{
  margin-top: 8px;
}

/* ë³´í—˜ì‚¬ ì¹´ë“œ */
.insurance-card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  margin: 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  width: 90%;
  white-space: normal;   /* ? ì¤„ë°”ê¿ˆ í—ˆìš© */
  word-break: keep-all;  /* ? ë‹¨ì–´ ë‹¨ìœ„ ì¤„ë°”ê¿ˆ (í•œêµ­ì–´ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆë¨) */
}
  
/* ì¹´ë“œ ì œëª© (ë³´í—˜ì‚¬ëª…) */
.insurance-card h4 {
  margin: 0 0 8px 0;
  text-align: center;       /* ? ê°€ìš´ë° ì •ë ¬ */
  white-space: normal;      /* ë„ˆë¬´ ê¸¸ë©´ ì¤„ë°”ê¿ˆ í—ˆìš© */
}
  
.insurance-card h3 {
  margin: 0 0 8px 0;
  text-align: center;       /* ? ê°€ìš´ë° ì •ë ¬ */
  white-space: normal;      /* ë„ˆë¬´ ê¸¸ë©´ ì¤„ë°”ê¿ˆ í—ˆìš© */
}

/* ì—°ë½ì²˜ ì•„ì´í…œ */
.insurance-card .contact-item {
  display: block;        /* ? ë¸”ë¡ ë‹¨ìœ„ë¡œ ìŒ“ì´ê²Œ */
  margin: 6px 0;
  font-size: 14px;
  text-align: center;
  white-space: normal;   /* ? ì¤„ë°”ê¿ˆ í—ˆìš© */
  word-break: break-word;/* ? ë„ˆë¬´ ê¸´ URL/ë²ˆí˜¸ ê°•ì œ ì¤„ë°”ê¿ˆ */
}
</style>
{% endblock %}


